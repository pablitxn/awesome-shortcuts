import React, { useState, useEffect, useRef } from 'react';
import { 
  Search, 
  Command, 
  Terminal, 
  MessageSquare, 
  X, 
  Send, 
  Sparkles,
  Plus,
  Settings,
  Keyboard,
  Moon,
  Sun,
  FileCode,
  FolderOpen,
  Save,
  Laptop
} from 'lucide-react';

// --- DATOS DE EJEMPLO (MOCK DATA) ---
const CATEGORIES = [
  { id: 'macos', label: 'macOS', icon: Command, color: 'blue' },
  { id: 'jetbrains', label: 'JetBrains', icon: CodeIcon, color: 'purple' },
  { id: 'tmux', label: 'Tmux', icon: Terminal, color: 'green' },
  { id: 'nvim', label: 'Neovim', icon: FileCode, color: 'emerald' },
];

const INITIAL_SHORTCUTS = [
  // macOS
  { id: 1, title: "Spotlight Search", keys: ["⌘", "Space"], category: "macos", description: "Búsqueda global rápida" },
  { id: 2, title: "Captura de Pantalla", keys: ["⌘", "Shift", "4"], category: "macos", description: "Seleccionar área para captura" },
  { id: 3, title: "Cambiar App", keys: ["⌘", "Tab"], category: "macos", description: "Navegar entre aplicaciones abiertas" },
  
  // JetBrains (IntelliJ / WebStorm)
  { id: 4, title: "Buscar en todo", keys: ["Shift", "Shift"], category: "jetbrains", description: "Busca clases, archivos, acciones" },
  { id: 5, title: "Acciones recientes", keys: ["⌘", "E"], category: "jetbrains", description: "Muestra archivos editados recientemente" },
  { id: 6, title: "Refactorizar", keys: ["Ctrl", "T"], category: "jetbrains", description: "Menú contextual de refactorización" },

  // Tmux
  { id: 7, title: "Split Vertical", keys: ["Ctrl+B", "%"], category: "tmux", description: "Divide el panel verticalmente" },
  { id: 8, title: "Split Horizontal", keys: ["Ctrl+B", "\""], category: "tmux", description: "Divide el panel horizontalmente" },
  { id: 9, title: "Nueva Ventana", keys: ["Ctrl+B", "C"], category: "tmux", description: "Crea una nueva ventana en la sesión" },

  // Neovim
  { id: 10, title: "Explorador de Archivos", keys: ["Space", "e"], category: "nvim", description: "Toggle file tree (custom map)" },
  { id: 11, title: "Buscar Archivos", keys: ["Space", "f", "f"], category: "nvim", description: "Telescope find files" },
  { id: 12, title: "Guardar", keys: ["Space", "w"], category: "nvim", description: "Write buffer" },
];

const QUOTES = [
  "There is no place like 127.0.0.1",
  "Talk is cheap. Show me the code.",
  "It works on my machine.",
  "Stay hungry, stay foolish.",
  "Premature optimization is the root of all evil.",
  "Code is like humor. When you have to explain it, it’s bad.",
  "Simplicity is the soul of efficiency.",
  "Make it work, make it right, make it fast.",
];

// Icono simple para Jetbrains/Code
function CodeIcon({ size, className }) {
  return (
    <svg 
      xmlns="http://www.w3.org/2000/svg" 
      width={size} 
      height={size} 
      viewBox="0 0 24 24" 
      fill="none" 
      stroke="currentColor" 
      strokeWidth="2" 
      strokeLinecap="round" 
      strokeLinejoin="round" 
      className={className}
    >
      <polyline points="16 18 22 12 16 6" />
      <polyline points="8 6 2 12 8 18" />
    </svg>
  );
}

// --- COMPONENTES UI ---

// Componente para visualizar una tecla individual
const KeyCap = ({ label, small = false, isDark }) => {
  const displayLabel = label === "Option" ? "⌥" : label === "Shift" ? "⇧" : label === "Control" || label === "Ctrl" ? "⌃" : label;
  const isSymbol = ["⌘", "⌥", "⇧", "⌃"].includes(displayLabel);
  
  // Estilos condicionales basados en el tema
  const bgClass = isDark ? "bg-gray-800 border-gray-950 text-gray-200" : "bg-white border-gray-300 text-gray-700";

  return (
    <div className={`
      relative group flex items-center justify-center 
      rounded-md border-b-[3px] 
      font-mono font-bold shadow-sm
      transform active:border-b-0 active:translate-y-[2px] transition-all duration-150
      select-none
      ${bgClass}
      ${small ? 'min-w-[28px] h-7 px-1.5 text-xs' : 'min-w-[40px] h-10 px-3 text-sm'}
    `}>
      <span className={isSymbol ? (small ? "text-sm leading-none" : "text-lg leading-none") : ""}>{displayLabel}</span>
    </div>
  );
};

// Modal de Configuración
const SettingsModal = ({ isOpen, onClose, isDark, toggleTheme }) => {
  if (!isOpen) return null;

  const bgModal = isDark ? "bg-gray-900 border-gray-700" : "bg-white border-gray-200";
  const textTitle = isDark ? "text-white" : "text-gray-900";
  const textSub = isDark ? "text-gray-400" : "text-gray-500";
  const inputBg = isDark ? "bg-gray-800 border-gray-700 text-white" : "bg-gray-50 border-gray-200 text-gray-900";

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
      <div className={`w-full max-w-2xl rounded-2xl border shadow-2xl overflow-hidden flex flex-col max-h-[90vh] ${bgModal}`}>
        
        {/* Header */}
        <div className={`p-6 border-b ${isDark ? 'border-gray-800' : 'border-gray-100'} flex justify-between items-center`}>
          <div>
            <h2 className={`text-xl font-bold ${textTitle}`}>Ajustes</h2>
            <p className={`text-sm ${textSub} mt-1`}>Personaliza la experiencia y tus fuentes de datos.</p>
          </div>
          <button onClick={onClose} className={`p-2 rounded-lg hover:bg-gray-500/10 transition-colors ${textSub}`}>
            <X size={20} />
          </button>
        </div>

        {/* Body */}
        <div className="p-6 overflow-y-auto space-y-8">
          
          {/* Sección Apariencia */}
          <div>
            <h3 className={`text-xs font-semibold uppercase tracking-wider mb-4 ${textSub}`}>Apariencia</h3>
            <div className={`flex items-center justify-between p-4 rounded-xl border ${isDark ? 'border-gray-800 bg-gray-800/30' : 'border-gray-100 bg-gray-50'}`}>
              <div className="flex items-center gap-3">
                <div className={`p-2 rounded-lg ${isDark ? 'bg-indigo-500/10 text-indigo-400' : 'bg-orange-100 text-orange-500'}`}>
                  {isDark ? <Moon size={20} /> : <Sun size={20} />}
                </div>
                <div>
                  <p className={`font-medium ${textTitle}`}>Modo {isDark ? 'Oscuro' : 'Claro'}</p>
                  <p className={`text-xs ${textSub}`}>Alternar el tema visual de la interfaz</p>
                </div>
              </div>
              <button 
                onClick={toggleTheme}
                className={`
                  relative inline-flex h-6 w-11 items-center rounded-full transition-colors
                  ${isDark ? 'bg-indigo-600' : 'bg-gray-300'}
                `}
              >
                <span className={`
                  inline-block h-4 w-4 transform rounded-full bg-white transition-transform
                  ${isDark ? 'translate-x-6' : 'translate-x-1'}
                `} />
              </button>
            </div>
          </div>

          {/* Sección Config Paths */}
          <div>
            <h3 className={`text-xs font-semibold uppercase tracking-wider mb-4 ${textSub}`}>Archivos de Configuración</h3>
            <div className="space-y-4">
              {CATEGORIES.filter(c => c.id !== 'macos').map(app => (
                <div key={app.id} className="group">
                  <label className={`block text-xs font-medium mb-1.5 ml-1 ${textTitle}`}>
                    {app.label} Path
                  </label>
                  <div className="flex gap-2">
                    <div className="relative flex-1">
                      <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <FileCode size={14} className={textSub} />
                      </div>
                      <input 
                        type="text" 
                        placeholder={app.id === 'nvim' ? '~/.config/nvim/init.lua' : app.id === 'tmux' ? '~/.tmux.conf' : ''}
                        className={`w-full pl-9 pr-4 py-2 rounded-lg border focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 outline-none transition-all text-xs font-mono ${inputBg}`}
                      />
                    </div>
                    <button className={`px-3 py-2 rounded-lg border font-medium text-xs hover:bg-gray-500/5 transition-colors flex items-center gap-2 ${isDark ? 'border-gray-700 text-gray-300' : 'border-gray-200 text-gray-700'}`}>
                      <FolderOpen size={14} />
                      Explorar
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className={`p-4 border-t ${isDark ? 'border-gray-800 bg-gray-900' : 'border-gray-100 bg-gray-50'} flex justify-end gap-3`}>
          <button onClick={onClose} className="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-medium shadow-lg shadow-indigo-500/20 flex items-center gap-2 transition-all active:scale-95">
            <Save size={16} />
            Guardar
          </button>
        </div>
      </div>
    </div>
  );
};

// Widget de Chat AI
const AIChatWidget = ({ isOpen, toggleChat, isDark }) => {
  const [messages, setMessages] = useState([
    { id: 1, sender: 'bot', text: '¡Hola! Puedo ayudarte a crear nuevos shortcuts en tu nvim o tmux config. ¿Qué necesitas?' }
  ]);
  const [input, setInput] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const scrollRef = useRef(null);

  const bgChat = isDark ? "bg-gray-900 border-gray-700" : "bg-white border-gray-200";
  const bgHeader = isDark ? "bg-gray-800 border-gray-700" : "bg-gray-50 border-gray-100";
  const textMain = isDark ? "text-gray-200" : "text-gray-800";
  const bgInput = isDark ? "bg-gray-800 border-gray-700" : "bg-gray-100 border-gray-200";

  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages, isOpen]);

  const handleSend = () => {
    if (!input.trim()) return;
    
    const userMsg = { id: Date.now(), sender: 'user', text: input };
    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setIsTyping(true);

    setTimeout(() => {
      setIsTyping(false);
      let botResponse = "Entendido. Procesando solicitud...";
      if (input.toLowerCase().includes('nvim')) {
        botResponse = "Veo que quieres un shortcut para Neovim. Puedo generar el código Lua para tu init.lua. ¿Lo agrego?";
      } else if (input.toLowerCase().includes('tmux')) {
        botResponse = "Claro, para Tmux te recomiendo usar 'bind -n'. ¿Quieres que lo agregue a tu .tmux.conf?";
      }
      setMessages(prev => [...prev, { id: Date.now() + 1, sender: 'bot', text: botResponse }]);
    }, 1200);
  };

  if (!isOpen) {
    return (
      <button 
        onClick={toggleChat}
        className="fixed bottom-20 right-8 w-12 h-12 bg-indigo-600 hover:bg-indigo-500 rounded-full flex items-center justify-center shadow-lg shadow-indigo-600/30 transition-all hover:scale-110 z-40 group"
      >
        <Sparkles className="text-white w-5 h-5 group-hover:rotate-12 transition-transform" />
      </button>
    );
  }

  return (
    <div className={`fixed bottom-24 right-8 w-80 md:w-96 h-[450px] border rounded-2xl shadow-2xl flex flex-col overflow-hidden z-40 animate-in slide-in-from-bottom-10 fade-in duration-300 ${bgChat}`}>
      <div className={`p-4 border-b flex justify-between items-center ${bgHeader}`}>
        <div className="flex items-center gap-2">
          <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
          <span className={`font-semibold ${textMain}`}>Shortcut Agent</span>
        </div>
        <button onClick={toggleChat} className="text-gray-400 hover:text-gray-600 transition-colors">
          <X size={18} />
        </button>
      </div>

      <div ref={scrollRef} className={`flex-1 overflow-y-auto p-4 space-y-4 ${isDark ? 'bg-gray-900/95' : 'bg-white'}`}>
        {messages.map((msg) => (
          <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`
              max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed shadow-sm
              ${msg.sender === 'user' 
                ? 'bg-indigo-600 text-white rounded-br-none' 
                : (isDark ? 'bg-gray-800 text-gray-200' : 'bg-gray-100 text-gray-800') + ' rounded-bl-none'}
            `}>
              {msg.text}
            </div>
          </div>
        ))}
        {isTyping && (
          <div className="flex justify-start">
            <div className={`p-3 rounded-2xl rounded-bl-none flex gap-1 ${isDark ? 'bg-gray-800' : 'bg-gray-100'}`}>
              <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
              <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-100"></span>
              <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-200"></span>
            </div>
          </div>
        )}
      </div>

      <div className={`p-3 border-t ${bgHeader}`}>
        <div className="relative">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleSend()}
            placeholder="Escribe tu solicitud..."
            className={`w-full pl-4 pr-10 py-3 rounded-xl border focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 placeholder-gray-500 text-sm ${bgInput} ${textMain}`}
          />
          <button 
            onClick={handleSend}
            className="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white transition-colors"
          >
            <Send size={14} />
          </button>
        </div>
      </div>
    </div>
  );
};

// --- APP PRINCIPAL ---

export default function App() {
  const [isDark, setIsDark] = useState(true);
  const [shortcuts, setShortcuts] = useState(INITIAL_SHORTCUTS);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('macos');
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [quote, setQuote] = useState("");

  useEffect(() => {
    // Random quote on mount
    setQuote(QUOTES[Math.floor(Math.random() * QUOTES.length)]);
  }, []);

  // Filtrado de shortcuts
  const filteredShortcuts = shortcuts.filter(shortcut => {
    const matchesSearch = shortcut.title.toLowerCase().includes(searchQuery.toLowerCase()) || 
                          shortcut.keys.join(' ').toLowerCase().includes(searchQuery.toLowerCase());
    const matchesCategory = shortcut.category === selectedCategory;
    return matchesSearch && matchesCategory;
  });

  // Clases dinámicas del tema principal
  const themeClasses = isDark 
    ? "bg-[#0d1117] text-gray-100 selection:bg-indigo-500/30" 
    : "bg-gray-50 text-gray-900 selection:bg-indigo-200";

  const cardBg = isDark ? "bg-gray-900/40 border-gray-800" : "bg-white border-gray-200 shadow-sm";
  const inputBg = isDark ? "bg-gray-900 border-gray-800 text-gray-100 placeholder-gray-500" : "bg-white border-gray-200 text-gray-900 placeholder-gray-400";
  const footerText = isDark ? "text-gray-500" : "text-gray-400";

  return (
    <div className={`min-h-screen font-sans transition-colors duration-300 flex flex-col ${themeClasses}`}>
      
      {/* Main Content Area - Full Height without header */}
      <main className="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 flex gap-12 w-full">
        
        {/* Sidebar Navigation */}
        <aside className="hidden md:flex flex-col w-56 flex-shrink-0 pt-2">
          <div className="mb-8 pl-3">
             <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20 mb-3">
                <Keyboard className="text-white w-6 h-6" />
             </div>
             <h1 className="font-bold text-lg tracking-tight">Awesome Shortcuts</h1>
          </div>

          <nav className="space-y-1">
            <p className={`px-3 text-[10px] font-bold uppercase tracking-wider mb-3 ${isDark ? 'text-gray-600' : 'text-gray-400'}`}>Apps</p>
            {CATEGORIES.map(category => {
              const Icon = category.icon;
              const isActive = selectedCategory === category.id;
              
              let btnClass = "w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-all ";
              if (isActive) {
                btnClass += isDark ? "bg-indigo-500/10 text-indigo-400" : "bg-indigo-50 text-indigo-700";
              } else {
                btnClass += isDark ? "text-gray-400 hover:text-gray-200" : "text-gray-500 hover:text-gray-900";
              }

              return (
                <button
                  key={category.id}
                  onClick={() => setSelectedCategory(category.id)}
                  className={btnClass}
                >
                  <Icon size={16} />
                  {category.label}
                </button>
              );
            })}
          </nav>
        </aside>

        {/* Content Section */}
        <section className="flex-1 min-w-0">
          {/* Search Bar Minimal */}
          <div className="relative mb-10 group max-w-2xl">
            <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <Search className={`h-4 w-4 transition-colors ${isDark ? 'text-gray-600 group-focus-within:text-indigo-400' : 'text-gray-400 group-focus-within:text-indigo-600'}`} />
            </div>
            <input
              type="text"
              className={`
                block w-full pl-10 pr-4 py-3 rounded-xl 
                focus:ring-0 focus:border-indigo-500 focus:outline-none
                transition-all text-sm font-medium
                ${inputBg}
              `}
              placeholder={`Filtrar comandos de ${CATEGORIES.find(c => c.id === selectedCategory)?.label}...`}
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
          </div>

          {/* Table View */}
          <div className="mb-6 flex items-center justify-between">
            <h2 className={`text-2xl font-bold tracking-tight ${isDark ? 'text-white' : 'text-gray-900'}`}>
              {CATEGORIES.find(c => c.id === selectedCategory)?.label}
            </h2>
            
            <button 
              onClick={() => setIsChatOpen(true)}
              className={`
                flex items-center gap-2 px-3 py-1.5 text-xs font-medium rounded-md transition-colors border
                ${isDark 
                  ? 'border-gray-800 text-gray-400 hover:border-indigo-500/50 hover:text-indigo-400' 
                  : 'border-gray-200 text-gray-500 hover:border-indigo-300 hover:text-indigo-600'}
              `}
            >
              <Plus size={14} />
              Agregar
            </button>
          </div>

          <div className={`rounded-xl overflow-hidden border ${cardBg}`}>
            <table className="w-full text-left border-collapse">
              <thead>
                <tr className={`border-b text-[10px] uppercase tracking-wider ${isDark ? 'border-gray-800 text-gray-500' : 'border-gray-100 text-gray-400'}`}>
                  <th className="px-6 py-3 font-semibold w-1/4">Shortcut</th>
                  <th className="px-6 py-3 font-semibold w-1/4">Teclas</th>
                  <th className="px-6 py-3 font-semibold w-1/3">Descripción</th>
                </tr>
              </thead>
              <tbody className={`divide-y ${isDark ? 'divide-gray-800/50' : 'divide-gray-100'}`}>
                {filteredShortcuts.map(shortcut => (
                  <tr 
                    key={shortcut.id} 
                    className={`group transition-colors ${isDark ? 'hover:bg-gray-800/30' : 'hover:bg-gray-50'}`}
                  >
                    <td className="px-6 py-4">
                      <span className={`text-sm font-medium transition-colors ${isDark ? 'text-gray-300 group-hover:text-indigo-300' : 'text-gray-700 group-hover:text-indigo-600'}`}>
                        {shortcut.title}
                      </span>
                    </td>
                    <td className="px-6 py-4">
                      <div className="flex flex-wrap gap-1.5">
                        {shortcut.keys.map((k, idx) => (
                          <React.Fragment key={idx}>
                            <KeyCap label={k} small isDark={isDark} />
                            {idx < shortcut.keys.length - 1 && (
                              <span className={`self-center text-[10px] font-bold ${isDark ? 'text-gray-600' : 'text-gray-400'}`}>+</span>
                            )}
                          </React.Fragment>
                        ))}
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <span className={`text-sm ${isDark ? 'text-gray-500' : 'text-gray-500'}`}>{shortcut.description}</span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            
            {filteredShortcuts.length === 0 && (
              <div className="text-center py-12">
                <p className={`text-sm ${isDark ? 'text-gray-600' : 'text-gray-400'}`}>Nada por aquí...</p>
              </div>
            )}
          </div>
        </section>
      </main>

      {/* Minimal Footer */}
      <footer className={`py-6 text-center text-xs border-t ${isDark ? 'border-gray-800' : 'border-gray-100'} ${footerText}`}>
        <p className="font-mono opacity-70 mb-2">"{quote}"</p>
        <div className="flex justify-center gap-4 opacity-50 hover:opacity-100 transition-opacity">
          <span>Awesome Shortcuts v0.1</span>
          <span>•</span>
          <button 
            onClick={() => setIsSettingsOpen(true)}
            className="hover:underline hover:text-indigo-500 cursor-pointer focus:outline-none"
          >
            Config
          </button>
        </div>
      </footer>

      {/* Floating Chat Widget */}
      <AIChatWidget isOpen={isChatOpen} toggleChat={() => setIsChatOpen(!isChatOpen)} isDark={isDark} />

      {/* Settings Modal */}
      <SettingsModal 
        isOpen={isSettingsOpen} 
        onClose={() => setIsSettingsOpen(false)} 
        isDark={isDark} 
        toggleTheme={() => setIsDark(!isDark)}
      />
      
    </div>
  );
}
